<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechZen Marketplace</title>
    <!-- Add this in the <head> section -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
<script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel = "stylesheet" href="/css/stylessell.css">

</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <h1><i class="fas fa-microchip"></i> TechZen</h1>
                </div>
                <div class="search-bar">
                    <input type="text" id="search-input" placeholder="Search products...">
                    <button id="search-btn"><i class="fas fa-search"></i></button>
                </div>
                <nav>
                    <ul class="nav-links">
                        <li><a href="/home.html" class="active">Home</a></li>
                        <li><a href="#" id="shop-link">Shop</a></li>
                        <li><a href="#" id="sell-link">Sell</a></li>
                        <li><a href="#" id="orders-link">Orders</a></li>
                        <li><a href="#" id="cart-link"><i class="fas fa-shopping-cart"></i> <span id="cart-count">0</span></a></li>
                        <li><a href="#" id="auth-link">Login / Sign Up</a></li>
                    </ul>
                </nav>
                <div class="mobile-menu-btn">
                    <i class="fas fa-bars"></i>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <div class="container">
            <!-- Filter Section -->
            <section class="filters-section" id="filters-section">
                <h2>Filters</h2>
                <div class="filter-group">
                    <h3>Categories</h3>
                    <div class="filter-options">
                        <label><input type="checkbox" name="category" value="laptops"> Laptops</label>
                        <label><input type="checkbox" name="category" value="smartphones"> Smartphones</label>
                        <label><input type="checkbox" name="category" value="accessories"> Accessories</label>
                        <label><input type="checkbox" name="category" value="components"> Components</label>
                        <label><input type="checkbox" name="category" value="audio"> Audio</label>
                    </div>
                </div>
                <div class="filter-group">
                    <h3>Condition</h3>
                    <div class="filter-options">
                        <label><input type="checkbox" name="condition" value="new"> New</label>
                        <label><input type="checkbox" name="condition" value="like-new"> Like New</label>
                        <label><input type="checkbox" name="condition" value="used"> Used</label>
                        <label><input type="checkbox" name="condition" value="refurbished"> Refurbished</label>
                    </div>
                </div>
                <div class="filter-group">
                    <h3>Price Range</h3>
                    <div class="price-slider">
                        <input type="range" id="min-price" min="0" max="10000" step="100" value="0">
                        <input type="range" id="max-price" min="0" max="10000" step="100" value="10000">
                        <div class="price-values">
                            <span id="min-price-value">0</span> - <span id="max-price-value">10000</span>
                        </div>
                    </div>
                </div>
                <button id="apply-filters">Apply Filters</button>
                <button id="clear-filters">Clear Filters</button>
            </section>

            <!-- Products Grid -->
            <section class="products-section" id="products-section">
                <h2>Featured Products</h2>
                <div class="products-grid" id="products-grid">
                    <!-- Products will be loaded dynamically -->
                    <div class="product-card-placeholder"></div>
                    <div class="product-card-placeholder"></div>
                    <div class="product-card-placeholder"></div>
                    <div class="product-card-placeholder"></div>
                    <div class="product-card-placeholder"></div>
                    <div class="product-card-placeholder"></div>
                </div>
            </section>

            <!-- Authentication Section -->
            <section class="auth-section" id="auth-section">
                <div class="auth-container">
                    <div class="auth-tabs">
                        <button class="auth-tab active" data-tab="login">Login</button>
                        <button class="auth-tab" data-tab="signup">Sign Up</button>
                    </div>
                    <div class="auth-form-container">
                        <!-- Login Form -->
                        <form id="login-form" class="auth-form active">
                            <h2>Login to Your Account</h2>
                            <div class="form-group">
                                <label for="login-email">Email</label>
                                <input type="email" id="login-email" required>
                            </div>
                            <div class="form-group">
                                <label for="login-password">Password</label>
                                <input type="password" id="login-password" required>
                            </div>
                            <button type="submit" class="btn-primary">Login</button>
                        </form>
                        
                        <!-- Sign Up Form -->
                        <form id="signup-form" class="auth-form">
                            <h2>Create an Account</h2>
                            <div class="form-group">
                                <label for="signup-name">Full Name</label>
                                <input type="text" id="signup-name" required>
                            </div>
                            <div class="form-group">
                                <label for="signup-email">Email</label>
                                <input type="email" id="signup-email" required>
                            </div>
                            <div class="form-group">
                                <label for="signup-password">Password</label>
                                <input type="password" id="signup-password" required>
                            </div>
                            <div class="form-group">
                                <label for="signup-confirm-password">Confirm Password</label>
                                <input type="password" id="signup-confirm-password" required>
                            </div>
                            <div class="form-group">
                                <label>Account Type</label>
                                <div class="radio-group">
                                    <label><input type="radio" name="account-type" value="buyer" checked> Buyer</label>
                                    <label><input type="radio" name="account-type" value="seller"> Seller</label>
                                </div>
                            </div>
                            <button type="submit" class="btn-primary">Sign Up</button>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Sell Product Section -->
            <section class="sell-section" id="sell-section">
                <h2>Sell Your Tech</h2>
                <form id="sell-form">
                    <div class="form-group">
                        <label for="product-name">Product Name</label>
                        <input type="text" id="product-name" required>
                    </div>
                    <div class="form-group">
                        <label for="product-description">Description</label>
                        <textarea id="product-description" rows="4" required></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="product-category">Category</label>
                            <select id="product-category" required>
                                <option value="">Select Category</option>
                                <option value="laptops">Laptops</option>
                                <option value="smartphones">Smartphones</option>
                                <option value="accessories">Accessories</option>
                                <option value="components">Components</option>
                                <option value="audio">Audio</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="product-condition">Condition</label>
                            <select id="product-condition" required>
                                <option value="">Select Condition</option>
                                <option value="new">New</option>
                                <option value="like-new">Like New</option>
                                <option value="used">Used</option>
                                <option value="refurbished">Refurbished</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="product-price">Price(Rs.)</label>
                            <input type="number" id="product-price" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="product-quantity">Quantity</label>
                            <input type="number" id="product-quantity" min="1" value="1" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="product-image">Product Images</label>
                        <input type="file" id="product-image" accept="image/*" multiple>
                        <div id="image-preview" class="image-preview"></div>
                    </div>
                    <button type="submit" class="btn-primary">List Product</button>
                </form>
            </section>

            <!-- Product Detail Section -->
            <section class="product-detail-section" id="product-detail-section">
                <!-- Product details will be loaded dynamically -->
            </section>

            <!-- Cart Section -->
            <section class="cart-section" id="cart-section">
                <h2>Your Cart</h2>
                <div class="cart-items" id="cart-items">
                    <!-- Cart items will be loaded dynamically -->
                </div>
                <div class="cart-summary">
                    <div class="cart-total">
                        <span>Total:</span>
                        <span id="cart-total-amount">$0.00</span>
                    </div>
                    <button id="checkout-btn" class="btn-primary">Proceed to Checkout</button>
                </div>
            </section>

            <!-- Checkout Section -->
            <section class="checkout-section" id="checkout-section">
                <h2>Checkout</h2>
                <div class="checkout-container">
                    <div class="checkout-form-container">
                        <form id="checkout-form">
                            <h3>Shipping Information</h3>
                            <div class="form-group">
                                <label for="shipping-name">Full Name</label>
                                <input type="text" id="shipping-name" required>
                            </div>
                            <div class="form-group">
                                <label for="shipping-address">Address</label>
                                <input type="text" id="shipping-address" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="shipping-city">City</label>
                                    <input type="text" id="shipping-city" required>
                                </div>
                                <div class="form-group">
                                    <label for="shipping-zip">ZIP Code</label>
                                    <input type="text" id="shipping-zip" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="shipping-country">Country</label>
                                <input type="text" id="shipping-country" required>
                            </div>
                            <div class="form-group">
                                <label for="shipping-phone">Phone</label>
                                <input type="tel" id="shipping-phone" required>
                            </div>

                            <h3>Payment Method</h3>
                            <div class="payment-methods">
                                <div class="payment-method">
                                    <input type="radio" id="credit-card" name="payment-method" value="credit-card" checked>
                                    <label for="credit-card">Credit/Debit Card</label>
                                </div>
                                <div class="payment-method">
                                    <input type="radio" id="paypal" name="payment-method" value="paypal">
                                    <label for="paypal">PayPal</label>
                                </div>
                                <div class="payment-method">
                                    <input type="radio" id="upi" name="payment-method" value="upi">
                                    <label for="upi">UPI</label>
                                </div>
                                <div class="payment-method">
                                    <input type="radio" id="crypto" name="payment-method" value="crypto">
                                    <label for="crypto">Cryptocurrency</label>
                                </div>
                            </div>

                            <!-- Credit Card Form -->
                            <div class="payment-details" id="credit-card-details">
                                <div class="form-group">
                                    <label for="card-number">Card Number</label>
                                    <input type="text" id="card-number" placeholder="1234 5678 9012 3456">
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="card-expiry">Expiry Date</label>
                                        <input type="text" id="card-expiry" placeholder="MM/YY">
                                    </div>
                                    <div class="form-group">
                                        <label for="card-cvv">CVV</label>
                                        <input type="text" id="card-cvv" placeholder="123">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="card-name">Name on Card</label>
                                    <input type="text" id="card-name">
                                </div>
                            </div>

                            <!-- PayPal Form -->
                            <div class="payment-details" id="paypal-details">
                                <p>You will be redirected to PayPal to complete your payment.</p>
                            </div>

                            <!-- UPI Form -->
                            <div class="payment-details" id="upi-details">
                                <div class="form-group">
                                    <label for="upi-id">UPI ID</label>
                                    <input type="text" id="upi-id" placeholder="example@ybl">
                                </div>
                            </div>

                            <!-- Crypto Form -->
                            <div class="payment-details" id="crypto-details">
                                <div class="form-group">
                                    <label for="crypto-currency">Select Cryptocurrency</label>
                                    <select id="crypto-currency">
                                        <option value="btc">Bitcoin (BTC)</option>
                                        <option value="eth">Ethereum (ETH)</option>
                                        <option value="usdt">Tether (USDT)</option>
                                    </select>
                                </div>
                                <p>Wallet address will be provided on the next step.</p>
                            </div>

                            <button type="submit" class="btn-primary">Place Order</button>
                        </form>
                    </div>
                    <div class="order-summary">
                        <h3>Order Summary</h3>
                        <div class="order-items" id="order-items">
                            <!-- Order items will be loaded dynamically -->
                        </div>
                        <div class="order-totals">
                            <div class="order-subtotal">
                                <span>Subtotal:</span>
                                <span id="order-subtotal">$0.00</span>
                            </div>
                            <div class="order-shipping">
                                <span>Shipping:</span>
                                <span id="order-shipping">$0.00</span>
                            </div>
                            <div class="order-tax">
                                <span>Tax:</span>
                                <span id="order-tax">$0.00</span>
                            </div>
                            <div class="order-total">
                                <span>Total:</span>
                                <span id="order-total">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Orders Section -->
            <section class="orders-section" id="orders-section">
                <h2>Your Orders</h2>
                <div class="orders-tabs">
                    <button class="orders-tab active" data-tab="active">Active Orders</button>
                    <button class="orders-tab" data-tab="completed">Completed Orders</button>
                </div>
                <div class="orders-list" id="orders-list">
                    <!-- Orders will be loaded dynamically -->
                </div>
            </section>

            <!-- Order Tracking Section -->
            <section class="order-tracking-section" id="order-tracking-section">
                <h2>Track Your Order</h2>
                <div class="order-details" id="tracking-order-details">
                    <!-- Order details will be loaded dynamically -->
                </div>
                <div class="tracking-status">
                    <div class="tracking-timeline" id="tracking-timeline">
                        <!-- Tracking timeline will be loaded dynamically -->
                    </div>
                </div>
                <div class="shipping-details" id="shipping-details">
                    <!-- Shipping details will be loaded dynamically -->
                </div>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <h2><i class="fas fa-microchip"></i> TechZen</h2>
                    <p>Your one-stop marketplace for tech products</p>
                </div>
                <div class="footer-links">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="#">Home</a></li>
                        <li><a href="#">Shop</a></li>
                        <li><a href="#">Sell</a></li>
                        <li><a href="#">My Account</a></li>
                    </ul>
                </div>
                <div class="footer-links">
                    <h3>Support</h3>
                    <ul>
                        <li><a href="#">FAQs</a></li>
                        <li><a href="#">Contact Us</a></li>
                        <li><a href="#">Shipping Policy</a></li>
                        <li><a href="#">Return Policy</a></li>
                    </ul>
                </div>
                <div class="footer-newsletter">
                    <h3>Stay Updated</h3>
                    <p>Subscribe to our newsletter for the latest products and deals</p>
                    <div class="newsletter-form">
                        <input type="email" placeholder="Your email address">
                        <button>Subscribe</button>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 TechZen Marketplace. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Toast Notifications -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="loading-spinner">
        <div class="spinner"></div>
    </div>
    
    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
      // Add at the beginning of your script section:
console.log('Selling page script loaded!');

// Global variables
let currentUser = null;
let cart = [];
let products = [];
let activeSection = 'products-section';

// Initialize the application
document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM fully loaded');
    loadCart();
    setupEventListeners();
    setupFilterToggle();
    navigateTo('products-section');
    fetchProducts().catch(err => console.error('Error in initial product fetch:', err));
});

// Setup all event listeners
function setupEventListeners() {
    // Navigation
    document.getElementById('shop-link').addEventListener('click', () => navigateTo('products-section'));
    document.getElementById('sell-link').addEventListener('click', () => {
        if (currentUser) {
            navigateTo('sell-section');
        } else {
            showToast('Please login to sell products', 'warning');
            navigateTo('auth-section');
        }
    });
    
    document.getElementById('orders-link').addEventListener('click', () => {
        if (currentUser) {
            navigateTo('orders-section');
            fetchOrders();
        } else {
            showToast('Please login to view orders', 'warning');
            navigateTo('auth-section');
        }
    });
    
    document.getElementById('cart-link').addEventListener('click', () => {
        navigateTo('cart-section');
        renderCart();
    });
    
    document.getElementById('auth-link').addEventListener('click', () => navigateTo('auth-section'));

    // Search
    document.getElementById('search-btn').addEventListener('click', handleSearch);
    document.getElementById('search-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleSearch();
    });

    // Filters
    document.getElementById('apply-filters').addEventListener('click', applyFilters);
    document.getElementById('clear-filters').addEventListener('click', clearFilters);
    
    // Auth tabs
    const authTabs = document.querySelectorAll('.auth-tab');
    authTabs.forEach(tab => {
        tab.addEventListener('click', () => switchAuthTab(tab));
    });

    // Auth forms
    document.getElementById('login-form').addEventListener('submit', handleLogin);
    document.getElementById('signup-form').addEventListener('submit', handleSignup);



    // Add this function to check seller authentication
async function checkSellerAuth() {
    try {
        const response = await fetch('/sell/auth/check', {
            method: 'GET',
            credentials: 'include'
        });
        
        if (!response.ok) {
            window.location.href = '/login.html';
            return false;
        }
        
        const data = await response.json();
        return data.user && data.user.accountType === 'seller';
    } catch (error) {
        console.error('Auth check failed:', error);
        return false;
    }
}

// Update the login form handler
document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;

    try {
        const response = await fetch('/sell/auth/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (!response.ok) {
            showToast(data.message || 'Login failed', 'error');
            return;
        }

        if (data.user.accountType !== 'seller') {
            showToast('Access denied. Seller account required.', 'error');
            return;
        }

        showToast('Login successful', 'success');
        window.location.href = '/selling.html';
    } catch (error) {
        console.error('Login error:', error);
        showToast('Login failed', 'error');
    }
});

// Add this to your DOMContentLoaded event
document.addEventListener('DOMContentLoaded', async () => {
    const isAuthenticated = await checkSellerAuth();
    if (!isAuthenticated) {
        showToast('Please login with a seller account', 'warning');
        window.location.href = '/login.html';
    }
});



    // Sell form
    document.getElementById('sell-form').addEventListener('submit', handleProductSubmit);
    document.getElementById('product-image').addEventListener('change', handleImagePreview);

    // Cart
    document.getElementById('checkout-btn').addEventListener('click', () => {
        if (!currentUser) {
            showToast('Please login to proceed to checkout', 'warning');
            navigateTo('auth-section');
            return;
        }
        
        if (cart.length === 0) {
            showToast('Your cart is empty', 'warning');
            return;
        }
        
        navigateTo('checkout-section');
        updateOrderSummary();
    });

    // Checkout
    document.getElementById('checkout-form').addEventListener('submit', handleCheckout);
    
    // Payment method selection
    const paymentMethods = document.querySelectorAll('input[name="payment-method"]');
    paymentMethods.forEach(method => {
        method.addEventListener('change', () => {
            document.querySelectorAll('.payment-details').forEach(detail => {
                detail.style.display = 'none';
            });
            document.getElementById(`${method.value}-details`).style.display = 'block';
        });
    });
    
    // Show credit card details by default
    document.getElementById('credit-card-details').style.display = 'block';

    // Orders tabs
    const ordersTabs = document.querySelectorAll('.orders-tab');
    ordersTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            ordersTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            fetchOrders(tab.dataset.tab);
        });
    });

    // Mobile menu
    document.querySelector('.mobile-menu-btn').addEventListener('click', toggleMobileMenu);

    // Modal close
    document.querySelector('.close-modal').addEventListener('click', closeModal);
}

// Toggle filters
function setupFilterToggle() {
    const filterToggleButton = document.createElement('button');
    filterToggleButton.id = 'filter-toggle-btn';
    filterToggleButton.className = 'btn-primary filter-toggle';
    filterToggleButton.style.marginBottom = '20px';
    filterToggleButton.innerHTML = '<i class="fas fa-filter"></i> Show Filters';
    
    const productsSection = document.getElementById('products-section');
    const containerDiv = document.querySelector('main .container');
    containerDiv.insertBefore(filterToggleButton, productsSection);
    
    document.getElementById('filters-section').style.display = 'none';
    
    filterToggleButton.addEventListener('click', () => {
        const filtersSection = document.getElementById('filters-section');
        if (filtersSection.style.display === 'none' || !filtersSection.style.display) {
            filtersSection.style.display = 'block';
            filterToggleButton.innerHTML = '<i class="fas fa-times"></i> Hide Filters';
        } else {
            filterToggleButton.innerHTML = '<i class="fas fa-filter"></i> Show Filters';
            filtersSection.style.display = 'none';
        }
    });
}

// Navigation
function navigateTo(sectionId) {
    if (sectionId === 'checkout-section' && !currentUser) {
        showToast('Please login to access checkout', 'warning');
        sectionId = 'auth-section';
    }
    
    const sections = document.querySelectorAll('main section');
    sections.forEach(section => {
        section.style.display = 'none';
    });
    
    document.getElementById(sectionId).style.display = 'block';
    activeSection = sectionId;
    
    if (sectionId === 'cart-section') {
        renderCart();
    }
    
    if (sectionId === 'checkout-section') {
        updateOrderSummary();
    }
    
    const navLinks = document.querySelectorAll('.nav-links a');
    navLinks.forEach(link => {
        link.classList.remove('active');
        if (link.id === `${sectionId.split('-')[0]}-link`) {
            link.classList.add('active');
        }
    });
    
    document.getElementById('filters-section').style.display = 'none';
    
    const filterToggleBtn = document.getElementById('filter-toggle-btn');
    if (filterToggleBtn) {
        if (sectionId === 'products-section') {
            filterToggleBtn.style.display = 'inline-block';
            filterToggleBtn.innerHTML = '<i class="fas fa-filter"></i> Show Filters';
        } else {
            filterToggleBtn.style.display = 'none';
        }
    }
    
    window.scrollTo(0, 0);
}

// Toggle mobile menu
function toggleMobileMenu() {
    const navLinks = document.querySelector('.nav-links');
    if (navLinks.style.display === 'flex') {
        navLinks.style.display = 'none';
    } else {
        navLinks.style.display = 'flex';
    }
}

// Products
async function fetchProducts(filters = {}) {
    showLoading();
    try {
        let url = '/api/products';
        
        if (Object.keys(filters).length > 0) {
            const params = new URLSearchParams();
            for (const key in filters) {
                if (Array.isArray(filters[key])) {
                    filters[key].forEach(value => {
                        params.append(`${key}[]`, value);
                    });
                } else {
                    params.append(key, filters[key]);
                }
            }
            url += `?${params.toString()}`;
        }
        
        console.log('Fetching products from:', url);
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error('Failed to fetch products');
        }
        
        products = await response.json();
        renderProducts(products);
    } catch (error) {
        console.error('Error fetching products:', error);
        showToast('Failed to load products', 'error');
    } finally {
        hideLoading();
    }
}

function renderProducts(productsToRender) {
    const productsGrid = document.getElementById('products-grid');
    productsGrid.innerHTML = '';
    
    if (productsToRender.length === 0) {
        productsGrid.innerHTML = `
            <div class="no-products-found">
                <lottie-player
                    src="https://assets1.lottiefiles.com/packages/lf20_uwR49J.json"
                    background="transparent"
                    speed="1"
                    style="width: 250px; height: 250px; margin: 0 auto;"
                    loop
                    autoplay
                ></lottie-player>
                <h3>No products found</h3>
                <p>Try different filters or search terms</p>
            </div>
        `;
        return;
    }
    
    productsToRender.forEach((product, index) => {
        const productCard = document.createElement('div');
        productCard.className = `product-card animate__animated animate__fadeIn`;
        productCard.style.animationDelay = `${index * 0.1}s`;
        
        const discountBadge = product.discount ? 
            `<div class="discount-badge">-${product.discount}%</div>` : '';
            
        const originalPrice = product.discount ? 
            `<span class="original-price">₹${(product.price * (1 + product.discount/100)).toFixed(2)}</span>` : '';
        
        productCard.innerHTML = `
            ${discountBadge}
            <div class="product-image-container">
                <img src="${product.images && product.images[0] ? product.images[0] : '/images/placeholder.jpg'}" 
                     alt="${product.name}" class="product-image">
                <div class="product-actions">
                    <button class="quick-view-btn" data-id="${product.id}">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="add-to-cart-btn" data-id="${product.id}">
                        <i class="fas fa-shopping-cart"></i>
                    </button>
                </div>
            </div>
            <div class="product-info">
                <div class="product-category">${product.category}</div>
                <h3 class="product-name">${product.name}</h3>
                <div class="product-rating">
                    ${generateRatingStars(product.rating || 0)}
                    <span class="rating-count">(${product.reviewCount || 0})</span>
                </div>
                <p class="product-price">
                    ${originalPrice}
                    ₹${product.price.toFixed(2)}
                </p>
                <div class="product-meta">
                    <span class="condition-badge ${product.condition.toLowerCase()}">${product.condition}</span>
                    <span class="stock-status ${product.quantity > 0 ? 'in-stock' : 'out-of-stock'}">
                        ${product.quantity > 0 ? 'In Stock' : 'Out of Stock'}
                    </span>
                </div>
                <button class="btn-primary view-product" data-id="${product.id}">View Details</button>
            </div>
        `;
        
        productCard.querySelector('.view-product').addEventListener('click', () => viewProductDetail(product.id));
        productCard.querySelector('.quick-view-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            quickViewProduct(product.id);
        });
        productCard.querySelector('.add-to-cart-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            addToCart(product);
            showAddToCartAnimation(e.target);
        });
        
        productsGrid.appendChild(productCard);
    });
}


function quickViewProduct(productId) {
    const product = products.find(p => p.id === productId);
    
    if (!product) return;
    
    const modalContent = `
        <div class="quick-view-container">
            <div class="quick-view-image">
                <img src="${product.images && product.images[0] ? product.images[0] : '/images/placeholder.jpg'}" alt="${product.name}">
            </div>
            <div class="quick-view-details">
                <h2>${product.name}</h2>
                <div class="product-rating">
                    ${generateRatingStars(product.rating || 0)}
                    <span class="rating-count">(${product.reviewCount || 0} reviews)</span>
                </div>
                <div class="quick-view-price">₹${product.price.toFixed(2)}</div>
                <p class="quick-view-description">${product.description}</p>
                <div class="quick-view-meta">
                    <div><strong>Category:</strong> ${product.category}</div>
                    <div><strong>Condition:</strong> ${product.condition}</div>
                    <div><strong>Stock:</strong> ${product.quantity} units</div>
                </div>
                <div class="quick-view-actions">
                    <div class="quantity-selector">
                        <button class="quantity-btn minus">-</button>
                        <input type="number" value="1" min="1" max="${product.quantity}" class="quantity-input">
                        <button class="quantity-btn plus">+</button>
                    </div>
                    <button class="btn-primary add-to-cart-btn">Add to Cart</button>
                </div>
                <button class="btn-secondary view-details-btn">View Full Details</button>
            </div>
        </div>
    `;
    
    showModal(modalContent);
    
    // Setup quantity buttons
    const quantityInput = document.querySelector('.quantity-input');
    document.querySelector('.minus').addEventListener('click', () => {
        if (parseInt(quantityInput.value) > 1) {
            quantityInput.value = parseInt(quantityInput.value) - 1;
        }
    });
    
    document.querySelector('.plus').addEventListener('click', () => {
        if (parseInt(quantityInput.value) < product.quantity) {
            quantityInput.value = parseInt(quantityInput.value) + 1;
        }
    });
    
    // Setup add to cart button
    document.querySelector('.add-to-cart-btn').addEventListener('click', () => {
        const quantity = parseInt(quantityInput.value);
        addToCart(product, quantity);
        closeModal();
    });
    
    // Setup view details button
    document.querySelector('.view-details-btn').addEventListener('click', () => {
        closeModal();
        viewProductDetail(product.id);
    });
}

async function viewProductDetail(productId) {
    showLoading();
    try {
        const response = await fetch(`/api/products/${productId}`);
        
        if (!response.ok) {
            throw new Error('Failed to fetch product details');
        }
        
        const product = await response.json();
        renderProductDetail(product);
        navigateTo('product-detail-section');
    } catch (error) {
        console.error('Error fetching product details:', error);
        showToast('Failed to load product details', 'error');
    } finally {
        hideLoading();
    }
}


function showAddToCartAnimation(target) {
    const cartIcon = document.querySelector('#cart-link i');
    const cartRect = cartIcon.getBoundingClientRect();
    const targetRect = target.getBoundingClientRect();
    
    const flyingIcon = document.createElement('div');
    flyingIcon.className = 'flying-icon';
    flyingIcon.innerHTML = '<i class="fas fa-shopping-cart"></i>';
    flyingIcon.style.position = 'fixed';
    flyingIcon.style.left = `${targetRect.left}px`;
    flyingIcon.style.top = `${targetRect.top}px`;
    flyingIcon.style.zIndex = '2000';
    flyingIcon.style.color = 'var(--primary-color)';
    flyingIcon.style.fontSize = '1.5rem';
    
    document.body.appendChild(flyingIcon);
    
    setTimeout(() => {
        flyingIcon.style.transition = 'all 0.8s cubic-bezier(0.18, 0.89, 0.32, 1.28)';
        flyingIcon.style.left = `${cartRect.left}px`;
        flyingIcon.style.top = `${cartRect.top}px`;
        flyingIcon.style.transform = 'scale(0.5)';
        flyingIcon.style.opacity = '0.5';
        
        setTimeout(() => {
            document.body.removeChild(flyingIcon);
            
            // Cart icon animation
            cartIcon.classList.add('animate__animated', 'animate__rubberBand');
            setTimeout(() => {
                cartIcon.classList.remove('animate__animated', 'animate__rubberBand');
            }, 1000);
        }, 800);
    }, 10);
}

function generateRatingStars(rating) {
    const fullStars = Math.floor(rating);
    const hasHalfStar = rating % 1 >= 0.5;
    const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
    
    let stars = '';
    
    // Full stars
    for (let i = 0; i < fullStars; i++) {
        stars += '<i class="fas fa-star"></i>';
    }
    
    // Half star
    if (hasHalfStar) {
        stars += '<i class="fas fa-star-half-alt"></i>';
    }
    
    // Empty stars
    for (let i = 0; i < emptyStars; i++) {
        stars += '<i class="far fa-star"></i>';
    }
    
    return stars;
}

function renderProductDetail(product) {
    const detailSection = document.getElementById('product-detail-section');
    
    const images = product.images && product.images.length > 0 ? product.images : ['/images/placeholder.jpg'];
    
    detailSection.innerHTML = `
        <div class="product-detail-container">
            <div class="product-detail-images">
                <img src="${images[0]}" alt="${product.name}" class="main-image" id="main-product-image">
                <div class="image-thumbnails">
                    ${images.map((img, index) => `
                        <img src="${img}" alt="${product.name}" class="image-thumbnail ${index === 0 ? 'active' : ''}" data-src="${img}">
                    `).join('')}
                </div>
            </div>
            <div class="product-detail-info">
                <h1 class="product-detail-name">${product.name}</h1>
                <p class="product-detail-price">${product.price.toFixed(2)}</p>
                <div class="product-detail-meta">
                    <span class="meta-item">${product.condition}</span>
                    <span class="meta-item">${product.category}</span>
                    <span class="meta-item">Stock: ${product.quantity}</span>
                </div>
                <div class="product-detail-description">
                    ${product.description}
                </div>
                <div class="product-quantity">
                    <span>Quantity:</span>
                    <div class="quantity-btn decrement">-</div>
                    <input type="number" class="quantity-input" value="1" min="1" max="${product.quantity}">
                    <div class="quantity-btn increment">+</div>
                </div>
                <div class="product-actions">
                    <button class="btn-primary" id="add-to-cart-btn">Add to Cart</button>
                </div>
                <div class="seller-info">
                    <h3>Seller Information</h3>
                    <p>Seller: ${product.seller ? product.seller.name : 'Unknown'}</p>
                </div>
            </div>
        </div>
    `;
    
    // Setup image gallery
    const thumbnails = detailSection.querySelectorAll('.image-thumbnail');
    const mainImage = detailSection.querySelector('#main-product-image');
    
    thumbnails.forEach(thumbnail => {
        thumbnail.addEventListener('click', () => {
            thumbnails.forEach(t => t.classList.remove('active'));
            thumbnail.classList.add('active');
            mainImage.src = thumbnail.dataset.src;
        });
    });
    
    // Setup quantity buttons
    const quantityInput = detailSection.querySelector('.quantity-input');
    detailSection.querySelector('.decrement').addEventListener('click', () => {
        if (parseInt(quantityInput.value) > 1) {
            quantityInput.value = parseInt(quantityInput.value) - 1;
        }
    });
    
    detailSection.querySelector('.increment').addEventListener('click', () => {
        if (parseInt(quantityInput.value) < product.quantity) {
            quantityInput.value = parseInt(quantityInput.value) + 1;
        }
    });
    
    // Setup add to cart button
    detailSection.querySelector('#add-to-cart-btn').addEventListener('click', () => {
        const quantity = parseInt(quantityInput.value);
        addToCart(product, quantity);
    });
}

// Search and Filters
function handleSearch() {
    const searchTerm = document.getElementById('search-input').value.trim();
    if (searchTerm) {
        fetchProducts({ search: searchTerm });
    } else {
        fetchProducts();
    }
}

function applyFilters() {
    const filters = {};
    
    // Categories
    const selectedCategories = [...document.querySelectorAll('input[name="category"]:checked')].map(input => input.value);
    if (selectedCategories.length > 0) {
        filters.categories = selectedCategories;
    }
    
    // Conditions
    const selectedConditions = [...document.querySelectorAll('input[name="condition"]:checked')].map(input => input.value);
    if (selectedConditions.length > 0) {
        filters.conditions = selectedConditions;
    }
    
    // Price Range
    const minPrice = document.getElementById('min-price').value;
    const maxPrice = document.getElementById('max-price').value;
    filters.minPrice = minPrice;
    filters.maxPrice = maxPrice;
    
    fetchProducts(filters);
}

function clearFilters() {
    document.querySelectorAll('input[name="category"], input[name="condition"]').forEach(input => {
        input.checked = false;
    });
    
    document.getElementById('min-price').value = 0;
    document.getElementById('max-price').value = 10000;
    document.getElementById('min-price-value').textContent = '0';
    document.getElementById('max-price-value').textContent = '10000';
    
    fetchProducts();
}

// Auth
function switchAuthTab(tab) {
    const tabName = tab.dataset.tab;
    
    document.querySelectorAll('.auth-tab').forEach(t => {
        t.classList.remove('active');
    });
    tab.classList.add('active');
    
    document.querySelectorAll('.auth-form').forEach(form => {
        form.classList.remove('active');
    });
    document.getElementById(`${tabName}-form`).classList.add('active');
}

async function handleLogin(e) {
    e.preventDefault();
    
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    
    if (!email || !password) {
        showToast('Please fill in all fields', 'warning');
        return;
    }
    
    showLoading();
    
    try {
        const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.message || 'Login failed');
        }
        
        // Save user session
        currentUser = data.user;
        sessionStorage.setItem('user', JSON.stringify(currentUser));
        
        // Update UI
        updateAuthUI();
        showToast('Login successful', 'success');
        navigateTo('products-section');
    } catch (error) {
        console.error('Login error:', error);
        showToast(error.message || 'Login failed', 'error');
    } finally {
        hideLoading();
    }
}

// Replace or update the signup form submission code
async function handleSignup(e) {
    e.preventDefault();
    
    const signupData = {
        name: document.getElementById('signup-name').value,
        email: document.getElementById('signup-email').value,
        password: document.getElementById('signup-password').value,
        accountType: document.querySelector('input[name="account-type"]:checked').value
    };

    try {
        const response = await fetch('/sell/auth/signup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(signupData)
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.message || 'Signup failed');
        }
        
        // Save user session
        currentUser = data.user;
        sessionStorage.setItem('user', JSON.stringify(currentUser));
        
        // Update UI
        updateAuthUI();
        showToast('Account created successfully', 'success');
        navigateTo('products-section');
    } catch (error) {
        console.error('Signup error:', error);
        showToast(error.message || 'Signup failed', 'error');
    }
}

function updateAuthUI() {
    const authLink = document.getElementById('auth-link');
    
    if (currentUser) {
        authLink.innerHTML = `<i class="fas fa-user"></i> ${currentUser.name}`;
        const oldListener = authLink.onclick;
        if (oldListener) {
            authLink.removeEventListener('click', oldListener);
        }
        authLink.addEventListener('click', showUserMenu);
    } else {
        authLink.innerHTML = 'Login / Sign Up';
        const oldListener = authLink.onclick;
        if (oldListener) {
            authLink.removeEventListener('click', oldListener);
        }
        authLink.addEventListener('click', () => navigateTo('auth-section'));
    }
}

function showUserMenu() {
    const modalBody = document.getElementById('modal-body');
    
    let content = `
        <h2>User Account</h2>
        <p>Welcome back, ${currentUser.name}!</p>
        <p>Email: ${currentUser.email}</p>
        <p>Account Type: ${currentUser.accountType}</p>
        <hr>
    `;
    
    // Add seller-specific options if the user is a seller
    if (currentUser.accountType === 'seller') {
        content += `<button id="my-products-btn" class="btn-primary">My Products</button><br><br>`;
    }
    
    content += `<button id="logout-btn" class="btn-primary">Logout</button>`;
    
    modalBody.innerHTML = content;
    
    // Add event listeners
    document.getElementById('logout-btn').addEventListener('click', logout);
    
    if (currentUser.accountType === 'seller') {
        document.getElementById('my-products-btn').addEventListener('click', () => {
            closeModal();
            showSellerProducts();
        });
    }
    
    showModal();
}

async function showSellerProducts() {
    if (!currentUser || currentUser.accountType !== 'seller') {
        showToast('You need a seller account to access this feature', 'warning');
        return;
    }
    
    showLoading();
    
    try {
        // Fetch all products
        const response = await fetch('/api/products');
        const allProducts = await response.json();
        
        // Filter for this seller's products
        const sellerProducts = allProducts.filter(product => 
            product.seller && product.seller.id === currentUser.id
        );
        
        const modalBody = document.getElementById('modal-body');
        modalBody.innerHTML = `
            <h2>My Products</h2>
            <div id="seller-products-list"></div>
        `;
        
        const productsList = document.getElementById('seller-products-list');
        
        if (sellerProducts.length === 0) {
            productsList.innerHTML = '<p>You haven\'t listed any products yet.</p>';
        } else {
            sellerProducts.forEach(product => {
                const productItem = document.createElement('div');
                productItem.className = 'seller-product-item';
                
                productItem.innerHTML = `
                    <img src="${product.images && product.images[0] ? product.images[0] : '/images/placeholder.jpg'}" alt="${product.name}" 
                        style="width: 60px; height: 60px; object-fit: cover; margin-right: 10px;">
                    <div style="flex: 1;">
                        <h4>${product.name}</h4>
                        <p>Price: ₹${product.price.toFixed(2)}</p>
                        <p>Stock: ${product.quantity}</p>
                    </div>
                    <div>
                        <button class="delete-product-btn btn-primary" data-id="${product.id}" 
                            style="background-color: #e74c3c;">Delete</button>
                    </div>
                `;
                
                productsList.appendChild(productItem);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-product-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteProduct(btn.dataset.id));
            });
        }
        
        showModal();
    } catch (error) {
        console.error('Error fetching seller products:', error);
        showToast('Failed to load your products', 'error');
    } finally {
        hideLoading();
    }
}

async function deleteProduct(productId) {
    if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
        showLoading();
        
        try {
            const response = await fetch(`/api/products/${productId}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.message || 'Failed to delete product');
            }
            
            showToast('Product deleted successfully', 'success');
            closeModal();
            
            // Refresh products if currently on products section
            if (activeSection === 'products-section') {
                fetchProducts();
            }
        } catch (error) {
            console.error('Error deleting product:', error);
            showToast(error.message || 'Failed to delete product', 'error');
        } finally {
            hideLoading();
        }
    }
}

function logout() {
    currentUser = null;
    sessionStorage.removeItem('user');
    updateAuthUI();
    closeModal();
    showToast('Logged out successfully', 'success');
    navigateTo('products-section');
}

// Sell Product
async function handleProductSubmit(e) {
    e.preventDefault();
    
    if (!currentUser) {
        showToast('Please login to sell products', 'warning');
        navigateTo('auth-section');
        return;
    }
    
    const productData = {
        name: document.getElementById('product-name').value,
        description: document.getElementById('product-description').value,
        category: document.getElementById('product-category').value,
        condition: document.getElementById('product-condition').value,
        price: parseFloat(document.getElementById('product-price').value),
        quantity: parseInt(document.getElementById('product-quantity').value),
        seller: {
            id: currentUser.id,
            name: currentUser.name
        }
    };
    
    if (!productData.name || !productData.description || !productData.category || !productData.condition || isNaN(productData.price)) {
        showToast('Please fill in all required fields', 'warning');
        return;
    }
    
    // Handle image uploads
    const imageInput = document.getElementById('product-image');
    if (imageInput.files.length > 0) {
        const formData = new FormData();
        
        // Add product data to FormData
        for (const key in productData) {
            if (key === 'seller') {
                formData.append(key, JSON.stringify(productData[key]));
            } else {
                formData.append(key, productData[key]);
            }
        }
        
        // Add images to FormData
        for (let i = 0; i < imageInput.files.length; i++) {
            formData.append('images', imageInput.files[i]);
        }
        
        showLoading();
        
        try {
            const response = await fetch('/api/products', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.message || 'Failed to add product');
            }
            
            // Reset form
            document.getElementById('sell-form').reset();
            document.getElementById('image-preview').innerHTML = '';
            
            showToast('Product added successfully', 'success');
            navigateTo('products-section');
            fetchProducts();
        } catch (error) {
            console.error('Error adding product:', error);
            showToast(error.message || 'Failed to add product', 'error');
        } finally {
            hideLoading();
        }
    } else {
        showToast('Please add at least one product image', 'warning');
    }
}

function handleImagePreview(e) {
    const files = e.target.files;
    const preview = document.getElementById('image-preview');
    preview.innerHTML = '';
    
    if (files) {
        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'preview-image';
                preview.appendChild(img);
            };
            reader.readAsDataURL(file);
        });
    }
}

// Cart Management
function addToCart(product, quantity = 1) {
    // Check if product already in cart
    const existingItem = cart.find(item => item.id === product.id);
    
    if (existingItem) {
        existingItem.quantity += quantity;
    } else {
        cart.push({
            id: product.id,
            name: product.name,
            price: product.price,
            image: product.images && product.images[0] ? product.images[0] : null,
            quantity: quantity
        });
    }
    
    // Save cart to localStorage
    saveCart();
    
    // Update cart count
    updateCartCount();
    
    showToast(`${product.name} added to cart`, 'success');
}

function updateCartCount() {
    const cartCount = document.getElementById('cart-count');
    const totalItems = cart.reduce((total, item) => total + item.quantity, 0);
    cartCount.textContent = totalItems;
}

function renderCart() {
    const cartItems = document.getElementById('cart-items');
    const cartTotalAmount = document.getElementById('cart-total-amount');
    
    if (cart.length === 0) {
        cartItems.innerHTML = '<p class="empty-cart-message">Your cart is empty.</p>';
        cartTotalAmount.textContent = '₹0.00';
        return;
    }
    
    cartItems.innerHTML = '';
    let total = 0;
    
    cart.forEach(item => {
        const itemTotal = item.price * item.quantity;
        total += itemTotal;
        
        const cartItem = document.createElement('div');
        cartItem.className = 'cart-item';
        cartItem.innerHTML = `
            <img src="${item.image || '/images/placeholder.jpg'}" alt="${item.name}" class="cart-item-image">
            <div class="cart-item-details">
                <h3>${item.name}</h3>
                <p>Price: ₹${item.price.toFixed(2)}</p>
                <p>Total: ₹${itemTotal.toFixed(2)}</p>
            </div>
            <div class="cart-item-actions">
                <button class="btn-primary decrease-quantity" data-id="${item.id}">-</button>
                <span>${item.quantity}</span>
                <button class="btn-primary increase-quantity" data-id="${item.id}">+</button>
                <button class="btn-primary remove-item" data-id="${item.id}"><i class="fas fa-trash"></i></button>
            </div>
        `;
        
        cartItems.appendChild(cartItem);
    });
    
    // Update total
    cartTotalAmount.textContent = `₹${total.toFixed(2)}`;
    
// Fix the cart event listeners in the renderCart function
document.querySelectorAll('.decrease-quantity').forEach(button => {
    button.addEventListener('click', () => {
        updateCartItemQuantity(button.dataset.id, -1);
    });
});

document.querySelectorAll('.increase-quantity').forEach(button => {
    button.addEventListener('click', () => {
        updateCartItemQuantity(button.dataset.id, 1);
    });
});

document.querySelectorAll('.remove-item').forEach(button => {
    button.addEventListener('click', () => {
        removeFromCart(button.dataset.id);
    });
});
}

// Cart Management continued
function updateCartItemQuantity(productId, change) {
    const existingItem = cart.find(item => item.id === productId);
    
    if (existingItem) {
        existingItem.quantity += change;
        
        if (existingItem.quantity <= 0) {
            // Remove item if quantity reaches zero or negative
            cart = cart.filter(item => item.id !== productId);
        }
        
        saveCart();
        updateCartCount();
        renderCart();
    }
}

function saveCart() {
    localStorage.setItem('techzen-cart', JSON.stringify(cart));
}

function loadCart() {
    try {
        const savedCart = localStorage.getItem('techzen-cart');
        if (savedCart) {
            cart = JSON.parse(savedCart);
            updateCartCount();
        }
        
        // Also try to load user from session storage
        const savedUser = sessionStorage.getItem('user');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            updateAuthUI();
        }
    } catch (error) {
        console.error('Error loading cart or user data:', error);
        // Reset in case of corrupted data
        cart = [];
        localStorage.removeItem('techzen-cart');
    }
}

function updateOrderSummary() {
    const orderItems = document.getElementById('order-items');
    orderItems.innerHTML = '';
    
    let subtotal = 0;
    const shipping = 49; // Fixed shipping cost
    
    cart.forEach(item => {
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;
        
        const orderItem = document.createElement('div');
        orderItem.className = 'order-item';
        orderItem.innerHTML = `
            <img src="${item.image || '/images/placeholder.jpg'}" alt="${item.name}" class="order-item-image">
            <div class="order-item-details">
                <h4>${item.name}</h4>
                <p>Quantity: ${item.quantity}</p>
                <p>Price: ₹${item.price.toFixed(2)}</p>
            </div>
            <div class="order-item-total">₹${itemTotal.toFixed(2)}</div>
        `;
        
        orderItems.appendChild(orderItem);
    });
    
    // Add order total breakdown
    const orderTotals = document.querySelector('.order-totals');
    const tax = subtotal * 0.18; // 18% GST
    const total = subtotal + shipping + tax;
    
    orderTotals.innerHTML = `
        <div class="order-subtotal">
            <span>Subtotal:</span>
            <span>₹${subtotal.toFixed(2)}</span>
        </div>
        <div class="order-shipping">
            <span>Shipping:</span>
            <span>₹${shipping.toFixed(2)}</span>
        </div>
        <div class="order-tax">
            <span>GST (18%):</span>
            <span>₹${tax.toFixed(2)}</span>
        </div>
        <div class="order-total">
            <span>Total:</span>
            <span>₹${total.toFixed(2)}</span>
        </div>
    `;
    
    // Auto-fill shipping details if user is logged in
    if (currentUser) {
        document.getElementById('shipping-name').value = currentUser.name || '';
    }
}

// Checkout
async function handleCheckout(e) {
    e.preventDefault();
    
    if (!currentUser) {
        showToast('Please login to checkout', 'warning');
        navigateTo('auth-section');
        return;
    }
    
    if (cart.length === 0) {
        showToast('Your cart is empty', 'warning');
        navigateTo('cart-section');
        return;
    }
    
    // Get shipping information
    const shippingInfo = {
        name: document.getElementById('shipping-name').value,
        address: document.getElementById('shipping-address').value,
        country: document.getElementById('shipping-country').value,
        phone: document.getElementById('shipping-phone').value
    };
    
    // Validate shipping info
    if (!shippingInfo.name || !shippingInfo.address || !shippingInfo.country || !shippingInfo.phone) {
        showToast('Please fill in all shipping information', 'warning');
        return;
    }
    
    // Get payment method
    const paymentMethod = document.querySelector('input[name="payment-method"]:checked');
    if (!paymentMethod) {
        showToast('Please select a payment method', 'warning');
        return;
    }
    
    // Calculate totals
    let subtotal = 0;
    const shipping = 49;
    
    cart.forEach(item => {
        subtotal += item.price * item.quantity;
    });
    
    const tax = subtotal * 0.18;
    const total = subtotal + shipping + tax;
    
    // Prepare order data
    const orderData = {
        user: currentUser.id,
        items: cart.map(item => ({
            id: item.id,
            name: item.name,
            price: item.price,
            quantity: item.quantity,
            total: item.price * item.quantity
        })),
        shipping: shippingInfo,
        payment: {
            method: paymentMethod.value,
            subtotal,
            shipping,
            tax,
            total
        }
    };
    
    showLoading();
    
    try {
        const response = await fetch('/api/orders', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(orderData)
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.message || 'Checkout failed');
        }
        
        // Clear cart
        cart = [];
        saveCart();
        updateCartCount();
        
        // Show success message and redirect
        showToast('Order placed successfully!', 'success');
        
        // Create an order confirmation modal
        const modalBody = document.getElementById('modal-body');
        modalBody.innerHTML = `
            <h2>Order Confirmation</h2>
            <p>Your order has been placed successfully!</p>
            <p>Order ID: ${data.order.id}</p>
            <p>Total Amount: ₹${data.order.payment.total.toFixed(2)}</p>
            <div class="modal-buttons">
                <button id="track-order-btn" class="btn-primary">Track Order</button>
                <button id="continue-shopping-btn" class="btn-secondary">Continue Shopping</button>
            </div>
        `;
        
        // Add event listeners to modal buttons
        showModal();
        document.getElementById('track-order-btn').addEventListener('click', () => {
            closeModal();
            trackOrder(data.order.id);
        });
        document.getElementById('continue-shopping-btn').addEventListener('click', () => {
            closeModal();
            navigateTo('products-section');
        });
    } catch (error) {
        console.error('Checkout error:', error);
        showToast(error.message || 'Checkout failed', 'error');
    } finally {
        hideLoading();
    }
}

// Orders
async function fetchOrders(status = 'active') {
    if (!currentUser) {
        showToast('Please login to view orders', 'warning');
        navigateTo('auth-section');
        return;
    }
    
    showLoading();
    
    try {
        const response = await fetch(`/api/orders?status=${status}`);
        
        if (!response.ok) {
            throw new Error('Failed to fetch orders');
        }
        
        const orders = await response.json();
        renderOrders(orders, status);
    } catch (error) {
        console.error('Error fetching orders:', error);
        showToast('Failed to load orders', 'error');
    } finally {
        hideLoading();
    }
}

function renderOrders(orders, status) {
    const ordersList = document.getElementById('orders-list');
    
    if (orders.length === 0) {
        ordersList.innerHTML = `<p>You have no ${status} orders.</p>`;
        return;
    }
    
    ordersList.innerHTML = '';
    
    orders.forEach(order => {
        const orderDate = new Date(order.date).toLocaleDateString();
        let totalItems = 0;
        order.items.forEach(item => totalItems += item.quantity);
        
        const orderElement = document.createElement('div');
        orderElement.className = 'order-card';
        orderElement.innerHTML = `
            <div class="order-header">
                <div class="order-info">
                    <h3>Order #${order.id.slice(0, 8)}</h3>
                    <p>Placed on ${orderDate}</p>
                </div>
                <div class="order-status ${order.status}">
                    <span>${order.status.replace('-', ' ').toUpperCase()}</span>
                </div>
            </div>
            <div class="order-details">
                <p>${totalItems} item(s) • Total: ₹${order.payment.total.toFixed(2)}</p>
            </div>
            <div class="order-actions">
                <button class="btn-primary view-order" data-id="${order.id}">View Details</button>
                <button class="btn-secondary track-order" data-id="${order.id}">Track Order</button>
            </div>
        `;
        
        ordersList.appendChild(orderElement);
    });
    
    // Add event listeners to buttons
    document.querySelectorAll('.view-order').forEach(button => {
        button.addEventListener('click', () => viewOrderDetails(button.dataset.id));
    });
    
    document.querySelectorAll('.track-order').forEach(button => {
        button.addEventListener('click', () => trackOrder(button.dataset.id));
    });
}

async function viewOrderDetails(orderId) {
    // Implementation for viewing order details
    showToast('Order details view coming soon!', 'info');
}

async function trackOrder(orderId) {
    showLoading();
    
    try {
        const response = await fetch(`/api/orders/${orderId}/track`);
        
        if (!response.ok) {
            throw new Error('Failed to track order');
        }
        
        const trackingInfo = await response.json();
        renderTrackingInfo(trackingInfo);
        navigateTo('order-tracking-section');
    } catch (error) {
        console.error('Error tracking order:', error);
        showToast('Failed to track order', 'error');
    } finally {
        hideLoading();
    }
}

function renderTrackingInfo(tracking) {
    const detailsSection = document.getElementById('tracking-order-details');
    const timelineSection = document.getElementById('tracking-timeline');
    const shippingDetails = document.getElementById('shipping-details');
    
    // Format dates
    const orderDate = new Date(tracking.date).toLocaleDateString('en-US', { 
        year: 'numeric', month: 'long', day: 'numeric' 
    });
    const estimatedDate = new Date(tracking.estimatedDelivery).toLocaleDateString('en-US', { 
        year: 'numeric', month: 'long', day: 'numeric' 
    });
    
    // Render order details
    detailsSection.innerHTML = `
        <div class="tracking-order-info">
            <h3>Order #${tracking.orderId.slice(0, 8)}</h3>
            <p>Placed on ${orderDate}</p>
            <p>Status: <span class="status-${tracking.status}">${tracking.status.replace('-', ' ').toUpperCase()}</span></p>
            <p>Tracking Number: ${tracking.trackingNumber}</p>
            <p>Carrier: ${tracking.carrier}</p>
            <p>Estimated Delivery: ${estimatedDate}</p>
        </div>
    `;
    
    // Render timeline
    timelineSection.innerHTML = `
        <div class="tracking-step ${tracking.currentStep === 'processing' || tracking.currentStep === 'shipped' || tracking.currentStep === 'out-for-delivery' || tracking.currentStep === 'delivered' ? 'completed' : ''}" data-step="processing">
            <div class="step-icon"><i class="fas fa-box"></i></div>
            <div class="step-content">
                <h4>Order Processing</h4>
                <p>${tracking.processingDate ? new Date(tracking.processingDate).toLocaleDateString() : 'Pending'}</p>
            </div>
        </div>
        <div class="tracking-step ${tracking.currentStep === 'shipped' || tracking.currentStep === 'out-for-delivery' || tracking.currentStep === 'delivered' ? 'completed' : ''}" data-step="shipped">
            <div class="step-icon"><i class="fas fa-shipping-fast"></i></div>
            <div class="step-content">
                <h4>Shipped</h4>
                <p>${tracking.shippedDate ? new Date(tracking.shippedDate).toLocaleDateString() : 'Pending'}</p>
            </div>
        </div>
        <div class="tracking-step ${tracking.currentStep === 'out-for-delivery' || tracking.currentStep === 'delivered' ? 'completed' : ''}" data-step="out-for-delivery">
            <div class="step-icon"><i class="fas fa-truck"></i></div>
            <div class="step-content">
                <h4>Out for Delivery</h4>
                <p>${tracking.outForDeliveryDate ? new Date(tracking.outForDeliveryDate).toLocaleDateString() : 'Pending'}</p>
            </div>
        </div>
        <div class="tracking-step ${tracking.currentStep === 'delivered' ? 'completed' : ''}" data-step="delivered">
            <div class="step-icon"><i class="fas fa-home"></i></div>
            <div class="step-content">
                <h4>Delivered</h4>
                <p>${tracking.deliveredDate ? new Date(tracking.deliveredDate).toLocaleDateString() : 'Pending'}</p>
            </div>
        </div>
    `;
    
    // Render shipping details
    shippingDetails.innerHTML = `
        <h3>Shipping Address</h3>
        <p>${tracking.shipping.name}</p>
        <p>${tracking.shipping.address}</p>
        <p>${tracking.shipping.country}</p>
        <p>Phone: ${tracking.shipping.phone}</p>
    `;
}

function showLoading() {
    let spinner = document.querySelector('.loading-spinner');
    if (!spinner) {
        spinner = document.createElement('div');
        spinner.className = 'loading-spinner';
        spinner.innerHTML = `
            <lottie-player
                src="https://assets5.lottiefiles.com/packages/lf20_usmfx6bp.json"
                background="transparent"
                speed="1"
                style="width: 150px; height: 150px;"
                loop
                autoplay
            ></lottie-player>
        `;
        document.body.appendChild(spinner);
    }
    spinner.style.display = 'flex';
}

function hideLoading() {
    const spinner = document.querySelector('.loading-spinner');
    if (spinner) {
        spinner.classList.add('animate__animated', 'animate__fadeOut');
        setTimeout(() => {
            spinner.style.display = 'none';
            spinner.classList.remove('animate__animated', 'animate__fadeOut');
        }, 300);
    }
}

function showToast(message, type = 'info') {
    const toastContainer = document.querySelector('.toast-container') || (() => {
        const container = document.createElement('div');
        container.className = 'toast-container';
        document.body.appendChild(container);
        return container;
    })();
    
    const icon = {
        'info': '<i class="fas fa-info-circle"></i>',
        'success': '<i class="fas fa-check-circle"></i>',
        'warning': '<i class="fas fa-exclamation-triangle"></i>',
        'error': '<i class="fas fa-exclamation-circle"></i>'
    };
    
    const toast = document.createElement('div');
    toast.className = `toast ${type} animate__animated animate__fadeInUp`;
    toast.innerHTML = `${icon[type]} <span>${message}</span>`;
    
    toastContainer.appendChild(toast);
    
    // Force reflow for animation to work
    toast.offsetHeight;
    toast.classList.add('show');
    
    setTimeout(() => {
        toast.classList.replace('animate__fadeInUp', 'animate__fadeOutDown');
        setTimeout(() => {
            toast.remove();
        }, 500);
    }, 3000);
}

function showModal(content = null) {
    const modal = document.querySelector('.modal') || (() => {
        const newModal = document.createElement('div');
        newModal.className = 'modal';
        newModal.innerHTML = `
            <div class="modal-content animate__animated animate__fadeInDown">
                <span class="close-modal">&times;</span>
                <div id="modal-body"></div>
            </div>
        `;
        document.body.appendChild(newModal);
        
        newModal.querySelector('.close-modal').addEventListener('click', closeModal);
        return newModal;
    })();
    
    if (content) {
        document.getElementById('modal-body').innerHTML = content;
    }
    
    modal.style.display = 'block';
    
    // Close modal when clicking outside
    window.onclick = function(event) {
        if (event.target == modal) {
            closeModal();
        }
    };
}

function closeModal() {
    const modal = document.querySelector('.modal');
    if (modal) {
        const modalContent = modal.querySelector('.modal-content');
        modalContent.classList.remove('animate__fadeInDown');
        modalContent.classList.add('animate__fadeOutUp');
        
        setTimeout(() => {
            modal.style.display = 'none';
            modalContent.classList.remove('animate__fadeOutUp');
            modalContent.classList.add('animate__fadeInDown');
        }, 300);
    }
}

</script>


</body>
</html>